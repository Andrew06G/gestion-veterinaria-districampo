<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Análisis</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/navbar-global.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="/admin"><strong>Admin</strong></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item"><a class="nav-link" href="/admin">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/propietarios">Propietarios</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/animales">Animales</a></li>
        <li class="nav-item"><a class="nav-link active" href="/admin/analisis">Análisis</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/registro">Registro Admin</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Salir</a></li>
      </ul>
    </div>
  </nav>

  <div class="container-fluid mt-5">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-10 col-lg-11">
        <h2 class="text-center mb-4">Gestión de Análisis</h2>
    
    <!-- Filtros -->
    <div class="row mb-4">
      <div class="col-md-4">
        <label for="ownerFilter">Filtrar por Propietario:</label>
        <select id="ownerFilter" class="form-control" onchange="loadAnimalsByOwner()">
          <option value="">-- Todos los propietarios --</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="animalFilter">Filtrar por Animal:</label>
        <select id="animalFilter" class="form-control" onchange="loadAnalysesByAnimal()">
          <option value="">-- Seleccione un animal --</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="statusFilter">Filtrar por Estado:</label>
        <select id="statusFilter" class="form-control" onchange="filterByStatus()">
          <option value="">-- Todos los estados --</option>
        </select>
      </div>
    </div>

    <!-- Lista de análisis -->
    <div id="analysesContainer" class="analyses-container">
      <!-- Los análisis se cargarán aquí dinámicamente -->
    </div>

    <!-- Controles de paginación -->
    <div id="paginationContainer" class="pagination-container" style="display: none;">
      <div class="d-flex justify-content-center align-items-center">
        <nav aria-label="Paginación de análisis">
          <ul class="pagination mb-0">
            <li class="page-item" id="prevPage">
              <a class="page-link" href="#" onclick="changePage('prev')">
                <i class="fas fa-chevron-left"></i> Anterior
              </a>
            </li>
            <li class="page-item active" id="currentPage">
              <span class="page-link" id="currentPageText">1</span>
            </li>
            <li class="page-item" id="nextPage">
              <a class="page-link" href="#" onclick="changePage('next')">
                Siguiente <i class="fas fa-chevron-right"></i>
              </a>
            </li>
          </ul>
        </nav>
        <div class="pagination-info ms-3">
          <small id="paginationInfo" class="text-muted">Mostrando 1-10 de 50 análisis</small>
        </div>
      </div>
    </div>

    <div id="noAnalysesMessage" class="alert alert-info text-center" style="display: none;">
      No se encontraron análisis para este filtro.
    </div>
      </div>
    </div>
  </div>

  <style>
    .analyses-container {
      max-width: 100%;
      width: 100%;
    }
    .analysis-card {
      transition: transform .15s ease, box-shadow .15s ease;
      border-radius: .9rem;
      box-shadow: 0 .35rem 1rem rgba(0,0,0,.08);
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 1.5rem auto;
    }
    .analysis-card:hover {
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 .75rem 1.5rem rgba(0,0,0,.18) !important;
    }
    .analysis-card .card-body { 
      padding: 2rem 3rem; 
    }
    .pagination-container {
      margin-top: 2rem;
      padding: 1rem 0;
    }
    .pagination {
      margin-bottom: 0;
    }
    .pagination .page-link {
      color: #007bff;
      border-color: #dee2e6;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .pagination .page-link:hover {
      color: #0056b3;
      background-color: #e9ecef;
      border-color: #dee2e6;
    }
    .pagination .page-item.active .page-link {
      background-color: #007bff;
      border-color: #007bff;
      color: white;
    }
    .pagination .page-item.disabled .page-link {
      color: #6c757d;
      background-color: #fff;
      border-color: #dee2e6;
      cursor: not-allowed;
    }
    .pagination .page-item.disabled .page-link:hover {
      color: #6c757d;
      background-color: #fff;
      border-color: #dee2e6;
    }
    .pagination-info {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .analysis-actions {
      margin-top: 1rem;
    }
    .analysis-actions .btn {
      min-width: 120px;
    }
    .animal-name {
      font-size: 1.4rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }
    .analysis-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #34495e;
      margin-bottom: 0.3rem;
    }
    .analysis-detail {
      font-size: 0.95rem;
      color: #6c757d;
      margin-bottom: 0.2rem;
    }
    .analysis-detail strong {
      color: #495057;
      font-weight: 600;
    }
    .analysis-actions .btn { 
      min-width: 120px; 
    }
    .form-control:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .resultado-categorico {
      display: none;
    }
    .resultado-libre {
      display: none;
    }
  </style>

  <script>
    function getToken() {
      return localStorage.getItem('adminToken');
    }
    
    if (!getToken()) {
      window.location.href = '/admin/login';
    }

    let allAnalyses = [];
    let allOwners = [];
    let allAnimals = [];
    let allStatuses = [];
    let currentPage = 1;
    let totalPages = 1;
    let totalRecords = 0;
    let currentFilters = {};

    async function api(path, options = {}) {
      const tk = getToken();
      if (!tk) {
        window.location.href = '/admin/login';
        return;
      }
      const res = await fetch(path, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + tk,
          ...(options.headers || {})
        }
      });
      if (res.status === 401) {
        window.location.href = '/admin/login';
        return;
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || ('Error ' + res.status));
      }
      return res.json();
    }

    function analysisCard(analysis) {
      const statusOptions = allStatuses.map(status => 
        `<option value="${status.id_tipo_estado}" ${analysis.id_estado == status.id_tipo_estado ? 'selected' : ''}>${status.nombre_estado}</option>`
      ).join('');

      const resultadoCategorico = ['Positivo', 'Negativo', 'Reactivo', 'No Reactivo', 'Normal', 'Anormal'];
      const resultadoOptions = resultadoCategorico.map(res => 
        `<option value="${res}" ${analysis.resultado === res ? 'selected' : ''}>${res}</option>`
      ).join('');

      return `
        <div class="row mb-4 justify-content-center">
          <div class="col-12">
            <div class="card analysis-card">
              <div class="card-body">
                <!-- Información del análisis -->
                <div class="analysis-info mb-4">
                  <div class="animal-name">${analysis.nombre_animal}</div>
                  <div class="analysis-title">${analysis.nombre_analisis}</div>
                  <div class="analysis-details">
                    <div class="analysis-detail"><strong>Tipo de Muestra:</strong> ${analysis.nombre_tipo_muestra}</div>
                    <div class="analysis-detail"><strong>Propietario:</strong> ${analysis.propietario_nombre}</div>
                    <div class="analysis-detail"><strong>Fecha de Toma:</strong> ${formatDate(analysis.fecha_toma)} ${analysis.hora_toma ? `(${String(analysis.hora_toma).slice(0,5)})` : ''}</div>
                  </div>
                </div>

                <!-- Formulario de edición -->
                <form class="analysis-form" data-id="${analysis.id_resultado}">
                  <!-- Fecha y hora de toma (ocultas) para validación -->
                  <input type="hidden" class="fecha-toma" value="${formatDateForInput(analysis.fecha_toma)}">
                  <input type="hidden" class="hora-toma" value="${analysis.hora_toma ? String(analysis.hora_toma).slice(0,5) : ''}">
                  <div class="row">
                    <div class="col-lg-3 col-md-6">
                      <div class="form-group">
                        <label><strong>Estado:</strong></label>
                        <select class="form-control estado-select" required onchange="toggleResultadoFields(this)">
                          <option value="">Seleccionar estado</option>
                          ${statusOptions}
                        </select>
                      </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                      <div class="form-group">
                        <label><strong>Fecha de Emisión:</strong></label>
                        <input type="date" class="form-control fecha-emision" value="${formatDateForInput(analysis.fecha_emision)}" min="${formatDateForInput(analysis.fecha_toma)}" required>
                      </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                      <div class="form-group">
                        <label><strong>Hora de Emisión:</strong></label>
                        <div class="form-control-plaintext">
                          <small class="text-muted">Se utilizará la hora actual del sistema</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                      <div class="form-group">
                        <label><strong>Tipo de Resultado:</strong></label>
                        <select class="form-control tipo-resultado" onchange="toggleResultadoType(this)" disabled>
                          <option value="">Seleccionar tipo de resultado...</option>
                          <option value="categorico">Categórico</option>
                          <option value="libre">Texto Libre</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                      <div class="form-group resultado-categorico">
                        <label><strong>Resultado Categórico:</strong></label>
                        <select class="form-control resultado-categorico-select" disabled>
                          <option value="">Seleccionar resultado</option>
                          ${resultadoOptions}
                          <option value="otro" ${!resultadoCategorico.includes(analysis.resultado) && analysis.resultado ? 'selected' : ''}>Otro</option>
                        </select>
                      </div>
                      <div class="form-group resultado-libre">
                        <label><strong>Resultado (Texto Libre):</strong></label>
                        <input type="text" class="form-control resultado-libre-input" 
                               value="${analysis.resultado && !resultadoCategorico.includes(analysis.resultado) ? analysis.resultado : ''}" 
                               placeholder="Ej: Hemoglobina: 12 g/dL" disabled>
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <label><strong>Observaciones:</strong></label>
                    <textarea class="form-control observaciones" rows="3" 
                              placeholder="Observaciones adicionales...">${analysis.observaciones || ''}</textarea>
                  </div>

                  <div class="d-flex justify-content-between analysis-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteAnalysis(${analysis.id_resultado}, '${analysis.nombre_animal}')">
                      <i class="fas fa-trash"></i> Eliminar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveAnalysis(${analysis.id_resultado})">
                      <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadOwners() {
      try {
        const data = await api('/api/admin/owners');
        if (!data) return;
        
        allOwners = data.owners;
        populateOwnerFilter();
      } catch (e) {
        // Error cargando propietarios, continuar sin mostrar al usuario
      }
    }

    async function loadStatuses() {
      try {
        const data = await api('/api/admin/statuses');
        if (!data) return;
        
        allStatuses = data.statuses;
        populateStatusFilter();
      } catch (e) {
        // Error cargando estados, continuar sin mostrar al usuario
      }
    }

    function populateOwnerFilter() {
      const select = document.getElementById('ownerFilter');
      select.innerHTML = '<option value="">-- Todos los propietarios --</option>';
      
      allOwners.forEach(owner => {
        const option = document.createElement('option');
        option.value = owner.id_propietario;
        option.textContent = `${owner.nombres} ${owner.apellidos}`;
        select.appendChild(option);
      });
    }

    function populateStatusFilter() {
      const select = document.getElementById('statusFilter');
      select.innerHTML = '<option value="">-- Todos los estados --</option>';
      
      allStatuses.forEach(status => {
        const option = document.createElement('option');
        option.value = status.id_tipo_estado;
        option.textContent = status.nombre_estado;
        select.appendChild(option);
      });
    }

    async function loadAnimalsByOwner() {
      currentPage = 1; // Resetear a página 1
      const ownerId = document.getElementById('ownerFilter').value;
      const animalSelect = document.getElementById('animalFilter');
      
      animalSelect.innerHTML = '<option value="">-- Seleccione un animal --</option>';
      
      // Actualizar filtros actuales
      currentFilters = { 
        owner: ownerId, 
        animal: '', 
        status: currentFilters.status || '' 
      };
      
      if (!ownerId) {
        allAnimals = [];
        // Cargar todos los animales cuando no hay propietario seleccionado
        loadAllAnimals();
        loadAllAnalyses();
        return;
      }

      try {
        const data = await api(`/api/admin/animals?owner=${ownerId}`);
        if (!data) return;
        
        allAnimals = data.animals;
        
        allAnimals.forEach(animal => {
          const option = document.createElement('option');
          option.value = animal.id_animal;
          option.textContent = animal.nombre_animal;
          animalSelect.appendChild(option);
        });

        // Cargar análisis del propietario seleccionado
        loadAnalysesByOwner(ownerId);
      } catch (e) {
        // Error cargando animales, continuar sin mostrar al usuario
      }
    }

    async function loadAllAnimals() {
      try {
        currentPage = 1; // Resetear a página 1
        
        // Actualizar filtros actuales
        currentFilters = { 
          owner: '', 
          animal: '', 
          status: currentFilters.status || '' 
        };
        
        const data = await api('/api/admin/animals');
        if (!data) return;
        
        allAnimals = data.animals;
        
        const animalSelect = document.getElementById('animalFilter');
        animalSelect.innerHTML = '<option value="">-- Seleccione un animal --</option>';
        
        allAnimals.forEach(animal => {
          const option = document.createElement('option');
          option.value = animal.id_animal;
          option.textContent = animal.nombre_animal;
          animalSelect.appendChild(option);
        });
      } catch (e) {
        // Error cargando animales, continuar sin mostrar al usuario
      }
    }

    async function loadAnalysesByOwner(ownerId) {
      try {
        const params = new URLSearchParams({
          owner: ownerId,
          page: currentPage,
          limit: 10
        });
        
        // Agregar filtros solo si tienen valor
        if (currentFilters.status) params.append('status', currentFilters.status);
        
        const data = await api(`/api/admin/analyses?${params}`);
        if (!data) return;
        
        allAnalyses = data.analyses;
        displayAnalyses(data);
      } catch (e) {
        // Error cargando análisis, continuar sin mostrar al usuario
      }
    }

    async function loadAnalysesByAnimal(animalId = null) {
      const selectedAnimalId = animalId || document.getElementById('animalFilter').value;
      
      if (!selectedAnimalId) {
        const ownerId = document.getElementById('ownerFilter').value;
        if (ownerId) {
          loadAnalysesByOwner(ownerId);
        } else {
          loadAllAnalyses();
        }
        return;
      }

      try {
        const params = new URLSearchParams({
          animal: selectedAnimalId,
          page: currentPage,
          limit: 10
        });
        
        // Agregar filtros solo si tienen valor
        if (currentFilters.status) params.append('status', currentFilters.status);
        
        const data = await api(`/api/admin/analyses?${params}`);
        if (!data) return;
        
        allAnalyses = data.analyses;
        displayAnalyses(data);
      } catch (e) {
        // Error cargando análisis, continuar sin mostrar al usuario
      }
    }

    async function loadAllAnalyses() {
      try {
        const params = new URLSearchParams({
          page: currentPage,
          limit: 10
        });
        
        // Agregar filtros solo si tienen valor
        if (currentFilters.status) params.append('status', currentFilters.status);
        
        const data = await api(`/api/admin/analyses?${params}`);
        if (!data) return;
        
        allAnalyses = data.analyses;
        displayAnalyses(data);
      } catch (e) {
        // Error cargando análisis, continuar sin mostrar al usuario
      }
    }

    function displayAnalyses(data) {
      const container = document.getElementById('analysesContainer');
      const noMessage = document.getElementById('noAnalysesMessage');
      const paginationContainer = document.getElementById('paginationContainer');
      
      // Limpiar contenedor antes de mostrar nuevos resultados
      container.innerHTML = '';
      
      if (data.analyses.length === 0) {
        noMessage.style.display = 'block';
        paginationContainer.style.display = 'none';
        return;
      }

      noMessage.style.display = 'none';
      container.innerHTML = data.analyses.map(analysisCard).join('');
      
      // Actualizar información de paginación
      if (data.pagination) {
        currentPage = data.pagination.currentPage;
        totalPages = data.pagination.totalPages;
        totalRecords = data.pagination.totalRecords;
        
        updatePaginationControls();
        paginationContainer.style.display = 'block';
      }
    }

    function filterByStatus() {
      currentPage = 1; // Resetear a página 1
      const statusId = document.getElementById('statusFilter').value;
      const ownerId = document.getElementById('ownerFilter').value;
      const animalId = document.getElementById('animalFilter').value;
      
      // Actualizar filtros actuales
      currentFilters = { 
        owner: ownerId, 
        animal: animalId, 
        status: statusId 
      };
      
      if (animalId) {
        loadAnalysesByAnimal();
      } else if (ownerId) {
        loadAnalysesByOwner(ownerId);
      } else {
        loadAllAnalyses();
      }
    }

    function toggleResultadoType(select) {
      const form = select.closest('.analysis-form');
      const categorico = form.querySelector('.resultado-categorico');
      const libre = form.querySelector('.resultado-libre');
      
      if (select.value === 'categorico') {
        categorico.style.display = 'block';
        libre.style.display = 'none';
        libre.querySelector('input').value = '';
      } else if (select.value === 'libre') {
        categorico.style.display = 'none';
        libre.style.display = 'block';
        categorico.querySelector('select').value = '';
      } else {
        categorico.style.display = 'none';
        libre.style.display = 'none';
        categorico.querySelector('select').value = '';
        libre.querySelector('input').value = '';
      }
    }

    function toggleResultadoFields(estadoSelect) {
      const form = estadoSelect.closest('.analysis-form');
      const tipoResultado = form.querySelector('.tipo-resultado');
      const categorico = form.querySelector('.resultado-categorico');
      const libre = form.querySelector('.resultado-libre');
      const categoricoSelect = form.querySelector('.resultado-categorico-select');
      const libreInput = form.querySelector('.resultado-libre-input');
      
      // Obtener el estado seleccionado
      const estado = estadoSelect.value;
      const estadoText = estadoSelect.options[estadoSelect.selectedIndex].text;
      
      if (estadoText === 'Finalizado') {
        // Habilitar campos de resultado
        tipoResultado.disabled = false;
        categoricoSelect.disabled = false;
        libreInput.disabled = false;
        
        // Si ya hay un tipo seleccionado, mostrar el campo correspondiente
        if (tipoResultado.value) {
          toggleResultadoType(tipoResultado);
        }
      } else {
        // Deshabilitar campos de resultado
        tipoResultado.disabled = true;
        tipoResultado.value = '';
        categoricoSelect.disabled = true;
        libreInput.disabled = true;
        categorico.style.display = 'none';
        libre.style.display = 'none';
        categoricoSelect.value = '';
        libreInput.value = '';
      }
    }


    async function saveAnalysis(resultadoId) {
      const form = document.querySelector(`form[data-id="${resultadoId}"]`);
      const estado = form.querySelector('.estado-select').value;
      const fechaEmision = form.querySelector('.fecha-emision').value;
      const fechaToma = form.querySelector('.fecha-toma')?.value || '';
      const horaToma = form.querySelector('.hora-toma')?.value || '';
      const tipoResultado = form.querySelector('.tipo-resultado').value;
      const observaciones = form.querySelector('.observaciones').value;
      
      let resultado = '';
      if (tipoResultado === 'categorico') {
        const select = form.querySelector('.resultado-categorico-select');
        resultado = select.value === 'otro' ? '' : select.value;
      } else {
        resultado = form.querySelector('.resultado-libre-input').value;
      }

      // Validaciones
      if (!estado) {
        alert('Por favor seleccione un estado');
        return;
      }
      if (!fechaEmision) {
        alert('Por favor seleccione una fecha de emisión');
        return;
      }

      // Validación: emisión debe ser posterior a toma (mismo día o posterior)
      if (fechaToma) {
        const tomaDate = new Date(fechaToma);
        const emisionDate = new Date(fechaEmision);
        if (emisionDate < tomaDate) {
          const tomaStr = new Date(fechaToma).toLocaleDateString('es-ES');
          alert(`La fecha de emisión no puede ser anterior a la fecha de toma (${tomaStr}).`);
          return;
        }
      }
      
      // Validaciones específicas cuando estado es "Finalizado"
      const estadoText = document.querySelector(`option[value="${estado}"]`).textContent;
      if (estadoText === 'Finalizado') {
        // Debe haberse elegido un tipo de resultado
        if (!tipoResultado) {
          alert('Seleccione un tipo de resultado (Texto libre o Categórico).');
          return;
        }
        // Si es categórico, debe seleccionar una categoría válida
        if (tipoResultado === 'categorico') {
          const select = form.querySelector('.resultado-categorico-select');
          const val = (select?.value || '').trim();
          if (!val) {
            alert('Seleccione una categoría para el resultado categórico.');
            return;
          }
        }
        // Si es texto libre, requiere contenido no vacío
        if (tipoResultado === 'libre') {
          const libreVal = (form.querySelector('.resultado-libre-input')?.value || '').trim();
          if (!libreVal) {
            alert('Ingrese un texto para el resultado.');
            return;
          }
        }
      }

      try {
        const res = await api(`/api/admin/analyses/${resultadoId}`, {
          method: 'PUT',
          body: JSON.stringify({
            id_estado: parseInt(estado),
            fecha_emision: fechaEmision,
            resultado: resultado.trim(),
            tipo_resultado: tipoResultado || '',
            observaciones: observaciones.trim()
          })
        });
        
        if (!res) return;
        
        alert('Análisis actualizado exitosamente. Se utilizó la hora actual del sistema.');
        loadAnalysesByAnimal(); // Recargar análisis
        
      } catch (e) {
        alert('Error al actualizar el análisis');
      }
    }

    // Funciones de paginación
    function updatePaginationControls() {
      const prevPage = document.getElementById('prevPage');
      const nextPage = document.getElementById('nextPage');
      const currentPageText = document.getElementById('currentPageText');
      const paginationInfo = document.getElementById('paginationInfo');
      
      // Actualizar texto de página actual
      currentPageText.textContent = currentPage;
      
      // Actualizar botones anterior/siguiente
      if (currentPage <= 1) {
        prevPage.classList.add('disabled');
      } else {
        prevPage.classList.remove('disabled');
      }
      
      if (currentPage >= totalPages) {
        nextPage.classList.add('disabled');
      } else {
        nextPage.classList.remove('disabled');
      }
      
      // Actualizar información de registros
      const startRecord = ((currentPage - 1) * 10) + 1;
      const endRecord = Math.min(currentPage * 10, totalRecords);
      paginationInfo.textContent = `Mostrando ${startRecord}-${endRecord} de ${totalRecords} análisis`;
    }

    function changePage(direction) {
      if (direction === 'prev' && currentPage > 1) {
        currentPage--;
        loadAnalysesWithPagination();
      } else if (direction === 'next' && currentPage < totalPages) {
        currentPage++;
        loadAnalysesWithPagination();
      }
    }

    function loadAnalysesWithPagination() {
      const ownerId = document.getElementById('ownerFilter').value;
      const animalId = document.getElementById('animalFilter').value;
      const statusId = document.getElementById('statusFilter').value;
      
      // Actualizar filtros actuales
      currentFilters = { owner: ownerId, animal: animalId, status: statusId };
      
      if (animalId) {
        loadAnalysesByAnimal(animalId);
      } else if (ownerId) {
        loadAnalysesByOwner(ownerId);
      } else {
        loadAllAnalyses();
      }
    }

    // Función para eliminar análisis
    async function deleteAnalysis(analysisId, animalName) {
      if (!confirm(`¿Está seguro de que desea eliminar el análisis de ${animalName}? Esta acción no se puede deshacer.`)) {
        return;
      }

      try {
        const res = await api(`/api/admin/analyses/${analysisId}`, {
          method: 'DELETE'
        });
        
        if (!res) return;
        
        alert('Análisis eliminado exitosamente');
        loadAnalysesWithPagination(); // Recargar análisis
        
      } catch (e) {
        alert('Error al eliminar el análisis');
      }
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('es-ES');
    }

    function formatDateForInput(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toISOString().split('T')[0]; // Formato YYYY-MM-DD
    }

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminUser');
      window.location.href = '/admin/login';
    }

    // Inicializar
    loadOwners();
    loadStatuses();
    loadAllAnimals();
    loadAllAnalyses();
  </script>
</body>
</html>