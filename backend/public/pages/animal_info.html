<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Información de Animales</title>
  <link rel="stylesheet" href="../assets/css/bootstrap-local.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <!-- Barra de navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
      <strong>DistriCampo</strong>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item"><a class="nav-link" href="/dashboard">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/animals">Registro de Animales</a></li>
        <li class="nav-item"><a class="nav-link active" href="/animal-info">Información de Animales</a></li>
        <li class="nav-item"><a class="nav-link" href="/solicitar-analisis">Solicitar Análisis</a></li>
        <li class="nav-item"><a class="nav-link" href="/mis-analisis">Mis Análisis</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Cerrar Sesión</a></li>
      </ul>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="text-center mb-4">
      <h2>Información de Animales</h2>
      <p class="text-muted">Gestiona la información de tus animales registrados</p>
    </div>

    <!-- Sección de animales registrados -->
    <div class="mt-4">
      <div id="animalesList">
        <!-- Los animales se cargarán aquí dinámicamente -->
      </div>
    </div>

    <!-- Formulario de edición fijo -->
    <div class="mt-5">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">Editar Animal</h4>
        </div>
        <div class="card-body">
          <form id="editAnimalForm">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_animal_select">Seleccionar Animal:</label>
                  <select class="form-control" id="edit_animal_select" onchange="cargarDatosAnimal()">
                    <option value="">Seleccione un animal para editar...</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_nombre_animal">Nombre del Animal:</label>
                  <input type="text" class="form-control" id="edit_nombre_animal" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_edad">Edad:</label>
                  <input type="number" class="form-control" id="edit_edad" required>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_id_especie">Especie:</label>
                  <select class="form-control" id="edit_id_especie" required>
                    <option value="">Seleccione una especie...</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_id_raza">Raza:</label>
                  <select class="form-control" id="edit_id_raza" required>
                    <option value="">Primero seleccione una especie...</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 text-right">
                <button type="button" class="btn btn-secondary" onclick="limpiarFormularioEdicion()">Cancelar</button>
                <button type="button" class="btn btn-primary ml-2" onclick="guardarEdicion()">Guardar Cambios</button>
                <button type="button" class="btn btn-danger ml-2" onclick="eliminarAnimalSeleccionado()" id="btnEliminar" style="display: none;">Eliminar Animal</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Incluir el sistema de gestión de sesión -->
  <script src="../assets/js/session.js"></script>
  <script src="../assets/js/script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Variables globales
    let animalesList = [];
    let animalSeleccionado = null;

    // Verificar si el usuario ha iniciado sesión
    document.addEventListener('DOMContentLoaded', () => {
      // Verificar autenticación usando el sistema de sesión
      if (!sessionManager.requireAuth()) {
        return;
      }

      // Cargar lista de animales
      cargarAnimales();
      // Cargar especies para el formulario de edición
      cargarEspecies();
    });

    async function cargarAnimales() {
      try {
        const token = sessionManager.getToken();
        const response = await fetch('/api/animals', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const animales = await response.json();
          animalesList = animales; // Guardar globalmente
          mostrarAnimales(animales);
          llenarDropdownAnimales(animales);
        } else {
          console.error('Error al cargar animales:', response.statusText);
          document.getElementById('animalesList').innerHTML = '<div class="alert alert-warning">No se pudieron cargar los animales.</div>';
        }
      } catch (error) {
        console.error('Error al cargar animales:', error);
        document.getElementById('animalesList').innerHTML = '<div class="alert alert-danger">Error al cargar los animales.</div>';
      }
    }

    function mostrarAnimales(animales) {
      const container = document.getElementById('animalesList');
      
      if (animales.length === 0) {
        container.innerHTML = '<div class="alert alert-info text-center">No tienes animales registrados. <a href="/animals">Registra tu primer animal aquí</a></div>';
        return;
      }

      let html = '<div class="row">';
      animales.forEach((animal, index) => {
        html += `
          <div class="col-md-6 mb-4">
            <div class="card animal-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="animal-info flex-grow-1">
                    <h4 class="card-title mb-3">${animal.nombre_animal}</h4>
                    <div class="animal-details">
                      <div class="detail-item mb-1"><strong>Edad:</strong> ${animal.edad} años</div>
                      <div class="detail-item mb-1"><strong>Raza:</strong> ${animal.nombre_raza}</div>
                      <div class="detail-item mb-1"><strong>Especie:</strong> ${animal.nombre_especie}</div>
                    </div>
                  </div>
                  <div class="animal-actions ml-3">
                    <button class="btn btn-warning btn-sm mb-2 d-block" onclick="seleccionarAnimalParaEditar(${animal.id_animal})">
                      <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm d-block" onclick="eliminarAnimal(${animal.id_animal}, '${animal.nombre_animal}')">
                      <i class="fas fa-trash"></i> Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    function llenarDropdownAnimales(animales) {
      const select = document.getElementById('edit_animal_select');
      select.innerHTML = '<option value="">Seleccione un animal para editar...</option>';
      
      animales.forEach(animal => {
        const option = document.createElement('option');
        option.value = animal.id_animal;
        option.textContent = animal.nombre_animal;
        select.appendChild(option);
      });
    }

    function seleccionarAnimalParaEditar(id) {
      const select = document.getElementById('edit_animal_select');
      select.value = id;
      cargarDatosAnimal();
      
      // Hacer scroll al formulario de edición con un pequeño delay
      setTimeout(() => {
        const formulario = document.querySelector('#editAnimalForm').closest('.card');
        if (formulario) {
          formulario.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
          });
        }
      }, 100);
    }

    async function cargarDatosAnimal() {
      const select = document.getElementById('edit_animal_select');
      const id = select.value;
      
      if (!id) {
        limpiarFormularioEdicion();
        return;
      }

      try {
        const token = sessionManager.getToken();
        const response = await fetch(`/api/animals/${id}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const animal = await response.json();
          animalSeleccionado = animal;
          
          // Llenar formulario
          document.getElementById('edit_nombre_animal').value = animal.nombre_animal;
          document.getElementById('edit_edad').value = animal.edad;
          
          // Cargar razas de la especie del animal
          await cargarRazas(animal.id_especie, animal.id_raza);
          
          // Mostrar botón de eliminar
          document.getElementById('btnEliminar').style.display = 'inline-block';
        } else {
          alert('Error al cargar datos del animal');
        }
      } catch (error) {
        console.error('Error al cargar datos del animal:', error);
        alert('Error al cargar datos del animal');
      }
    }

    async function cargarEspecies() {
      try {
        const token = sessionManager.getToken();
        const response = await fetch('/api/animals/especies/list', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const especies = await response.json();
          const select = document.getElementById('edit_id_especie');
          
          select.innerHTML = '<option value="">Seleccione una especie...</option>';
          especies.forEach(especie => {
            const option = document.createElement('option');
            option.value = especie.id_especie;
            option.textContent = especie.nombre_especie;
            select.appendChild(option);
          });

          // Configurar evento de cambio de especie
          select.addEventListener('change', async (e) => {
            const id_especie = e.target.value;
            if (id_especie) {
              await cargarRazas(id_especie);
            } else {
              const razaSelect = document.getElementById('edit_id_raza');
              razaSelect.innerHTML = '<option value="">Primero seleccione una especie...</option>';
            }
          });
        }
      } catch (error) {
        console.error('Error al cargar especies:', error);
      }
    }

    async function cargarRazas(id_especie, id_raza_seleccionada = null) {
      try {
        const token = sessionManager.getToken();
        const response = await fetch(`/api/animals/razas/especie/${id_especie}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const razas = await response.json();
          const select = document.getElementById('edit_id_raza');
          
          select.innerHTML = '<option value="">Seleccione una raza...</option>';
          razas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza.id_raza;
            option.textContent = raza.nombre_raza;
            if (raza.id_raza === id_raza_seleccionada) {
              option.selected = true;
            }
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error al cargar razas:', error);
      }
    }

    function limpiarFormularioEdicion() {
      document.getElementById('edit_animal_select').value = '';
      document.getElementById('edit_nombre_animal').value = '';
      document.getElementById('edit_edad').value = '';
      document.getElementById('edit_id_especie').value = '';
      document.getElementById('edit_id_raza').value = '';
      document.getElementById('btnEliminar').style.display = 'none';
      animalSeleccionado = null;
    }

    async function eliminarAnimal(id, nombre) {
      if (confirm(`¿Estás seguro de que quieres eliminar a ${nombre}?`)) {
        try {
          const token = sessionManager.getToken();
          const response = await fetch(`/api/animals/${id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            alert('Animal eliminado exitosamente');
            cargarAnimales(); // Recargar la lista
          } else {
            const errorData = await response.json();
            alert('Error: ' + errorData.message);
          }
        } catch (error) {
          console.error('Error al eliminar animal:', error);
          alert('Error al eliminar el animal');
        }
      }
    }


    async function guardarEdicion() {
      if (!animalSeleccionado) {
        alert('Por favor, seleccione un animal para editar');
        return;
      }

      try {
        const nombre_animal = document.getElementById('edit_nombre_animal').value.trim();
        const edad = document.getElementById('edit_edad').value.trim();
        const id_raza = document.getElementById('edit_id_raza').value.trim();
        const id_especie = document.getElementById('edit_id_especie').value.trim();

        if (!nombre_animal || !edad || !id_raza || !id_especie) {
          alert('Por favor, complete todos los campos');
          return;
        }

        const token = sessionManager.getToken();
        const response = await fetch(`/api/animals/${animalSeleccionado.id_animal}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            nombre_animal,
            edad: parseInt(edad),
            id_raza: parseInt(id_raza),
            id_especie: parseInt(id_especie)
          })
        });

        if (response.ok) {
          alert('Animal actualizado exitosamente');
          // Recargar lista
          cargarAnimales();
          // Limpiar formulario
          limpiarFormularioEdicion();
        } else {
          const errorData = await response.json();
          alert('Error: ' + errorData.message);
        }
      } catch (error) {
        console.error('Error al actualizar animal:', error);
        alert('Error al actualizar el animal');
      }
    }

    async function eliminarAnimalSeleccionado() {
      if (!animalSeleccionado) {
        alert('Por favor, seleccione un animal para eliminar');
        return;
      }

      if (confirm(`¿Estás seguro de que quieres eliminar a ${animalSeleccionado.nombre_animal}?`)) {
        try {
          const token = sessionManager.getToken();
          const response = await fetch(`/api/animals/${animalSeleccionado.id_animal}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            alert('Animal eliminado exitosamente');
            // Recargar lista
            cargarAnimales();
            // Limpiar formulario
            limpiarFormularioEdicion();
          } else {
            const errorData = await response.json();
            alert('Error: ' + errorData.message);
          }
        } catch (error) {
          console.error('Error al eliminar animal:', error);
          alert('Error al eliminar el animal');
        }
      }
    }

    function logout() {
      sessionManager.logout();
      window.location.href = '/login';
    }
  </script>

  <style>
    .animal-card {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      height: 100%;
      background: #fff;
    }

    .animal-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .animal-card .card-body {
      padding: 1.5rem;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .animal-card .card-title {
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 1rem;
      font-size: 1.25rem;
    }

    .animal-info {
      flex-grow: 1;
    }

    .animal-details {
      margin-bottom: 1rem;
    }

    .detail-item {
      color: #6c757d;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .animal-actions {
      flex-shrink: 0;
      min-width: 120px;
    }

    .animal-actions .btn {
      width: 100%;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
    }

    .animal-actions .btn:last-child {
      margin-bottom: 0;
    }

    .btn-sm {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }

    .ml-3 {
      margin-left: 1rem;
    }

    .mb-1 {
      margin-bottom: 0.25rem;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .mb-3 {
      margin-bottom: 1rem;
    }

    .mb-4 {
      margin-bottom: 1.5rem;
    }

    .d-block {
      display: block !important;
    }

    @media (max-width: 768px) {
      .animal-card .card-body {
        padding: 1rem;
      }
      
      .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
      }
      
      .animal-actions {
        margin-top: 1rem;
        margin-left: 0 !important;
        width: 100%;
        min-width: auto;
      }

      .animal-actions .btn {
        display: inline-block;
        width: auto;
        margin-right: 0.5rem;
        margin-bottom: 0;
      }
    }
  </style>
</body>
</html>
