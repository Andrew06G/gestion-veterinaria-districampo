
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Usuario</title>
  <link rel="stylesheet" href="../assets/css/bootstrap-local.css">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body style="background-color: #b3b3b3;">
  <!-- Barra de navegación -->
  <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
      DistriCampo
    </a>
    <div class="navbar-nav">
      <a class="nav-link" href="/login">Iniciar Sesión</a>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="text-center mb-4">
      <h1>DistriCampo</h1>
    </div>
    <h2 class="text-center">Registro de Usuario</h2>
    <form id="registerForm">
      <div class="form-group">
        <label for="nombres">Nombres:</label>
        <input type="text" class="form-control" id="nombres" name="nombres" required>
      </div>
      <div class="form-group">
        <label for="apellidos">Apellidos:</label>
        <input type="text" class="form-control" id="apellidos" name="apellidos" required>
      </div>
      <div class="form-group">
        <label for="correo_electronico">Correo Electrónico:</label>
        <input type="email" class="form-control" id="correo_electronico" name="correo_electronico" required>
      </div>
      <div class="form-group">
        <label for="telefono">Teléfono:</label>
        <input type="tel" class="form-control" id="telefono" name="telefono" required pattern="\d{7,15}">
      </div>
      <div class="form-group">
        <label for="direccion">Dirección:</label>
        <input type="text" class="form-control" id="direccion" name="direccion" required>
      </div>
      <div class="form-group">
        <label for="contrasena">Contraseña:</label>
        <input type="password" class="form-control" id="contrasena" name="contrasena" required minlength="8">
        
        <!-- Indicador de fortaleza de contraseña -->
        <div class="mt-2">
          <div class="progress" style="height: 8px;">
            <div id="passwordStrengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
          <small id="passwordStrengthText" class="text-muted">Fortaleza de la contraseña</small>
        </div>
        
        <!-- Lista de requisitos -->
        <div class="mt-2">
          <small class="text-muted">La contraseña debe cumplir:</small>
          <ul class="list-unstyled mt-1" style="font-size: 0.85em;">
            <li id="reqLength"><span class="text-danger">✗</span> Mínimo 8 caracteres</li>
            <li id="reqLowercase"><span class="text-danger">✗</span> Al menos una minúscula</li>
            <li id="reqUppercase"><span class="text-danger">✗</span> Al menos una mayúscula</li>
            <li id="reqNumber"><span class="text-danger">✗</span> Al menos un número</li>
            <li id="reqSpecial"><span class="text-danger">✗</span> Al menos un carácter especial</li>
          </ul>
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-block">Registrarse</button>
    </form>
    
    <div class="text-center mt-3">
      <p>¿Ya tienes cuenta? <a href="/login">Inicia sesión aquí</a></p>
    </div>
  </div>

  <script src="../assets/js/script.js"></script>
  <script>
    // Función para validar fortaleza de contraseña
    function validatePasswordStrength(password) {
      const validations = {
        length: password.length >= 8,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        numbers: /\d/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
      };
      
      const score = Object.values(validations).filter(Boolean).length;
      const maxScore = Object.keys(validations).length;
      
      let strength = 'Débil';
      let color = 'danger';
      
      if (score >= 4) {
        strength = 'Fuerte';
        color = 'success';
      } else if (score >= 3) {
        strength = 'Media';
        color = 'warning';
      }
      
      return {
        score,
        maxScore,
        strength,
        color,
        validations,
        percentage: Math.round((score / maxScore) * 100)
      };
    }

    // Función para actualizar indicadores de contraseña
    function updatePasswordIndicators(password) {
      const validation = validatePasswordStrength(password);
      
      // Actualizar barra de progreso
      const strengthBar = document.getElementById('passwordStrengthBar');
      const strengthText = document.getElementById('passwordStrengthText');
      
      strengthBar.style.width = validation.percentage + '%';
      strengthBar.className = `progress-bar bg-${validation.color}`;
      strengthText.textContent = `Fortaleza: ${validation.strength} (${validation.percentage}%)`;
      
      // Actualizar requisitos
      const reqs = {
        length: document.getElementById('reqLength'),
        lowercase: document.getElementById('reqLowercase'),
        uppercase: document.getElementById('reqUppercase'),
        numbers: document.getElementById('reqNumber'),
        special: document.getElementById('reqSpecial')
      };
      
      // Actualizar cada requisito
      Object.keys(validation.validations).forEach(key => {
        const req = reqs[key];
        if (req) {
          const icon = req.querySelector('span');
          if (validation.validations[key]) {
            icon.className = 'text-success';
            icon.textContent = '✓';
          } else {
            icon.className = 'text-danger';
            icon.textContent = '✗';
          }
        }
      });
      
      return validation;
    }

    // Agregar evento para validación en tiempo real
    document.getElementById('contrasena').addEventListener('input', function() {
      const password = this.value;
      updatePasswordIndicators(password);
    });

    document.getElementById('registerForm').addEventListener('submit', function (e) {
      e.preventDefault();
      
      // Mostrar spinner de carga
      if (window.DistriCampoUtils && window.DistriCampoUtils.showSpinner) {
        window.DistriCampoUtils.showSpinner(true);
      }
      
      const nombres = document.getElementById('nombres').value.trim();
      const apellidos = document.getElementById('apellidos').value.trim();
      const correo_electronico = document.getElementById('correo_electronico').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const direccion = document.getElementById('direccion').value.trim();
      const contrasena = document.getElementById('contrasena').value.trim();

      if (!nombres || !apellidos || !correo_electronico || !telefono || !direccion || !contrasena) {
        alert('Por favor, complete todos los campos.');
        if (window.DistriCampoUtils && window.DistriCampoUtils.showSpinner) {
          window.DistriCampoUtils.showSpinner(false);
        }
        return;
      }

      // Validar contraseña con todos los requisitos
      const passwordValidation = validatePasswordStrength(contrasena);
      if (passwordValidation.score < 3) {
        alert('La contraseña es muy débil. Debe cumplir al menos 3 de los 5 requisitos de seguridad.');
        if (window.DistriCampoUtils && window.DistriCampoUtils.showSpinner) {
          window.DistriCampoUtils.showSpinner(false);
        }
        return;
      }

      // Validar formato de correo electrónico
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(correo_electronico)) {
        alert('Por favor, ingrese un formato de correo electrónico válido.');
        if (window.DistriCampoUtils && window.DistriCampoUtils.showSpinner) {
          window.DistriCampoUtils.showSpinner(false);
        }
        return;
      }

      // Realizar la solicitud al backend
      fetch('/api/users/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          nombres,
          apellidos,
          correo_electronico,
          telefono,
          direccion,
          contrasena
        })
      })
      .then(response => {
        if (response.ok) {
          alert('Usuario registrado exitosamente. Ahora puede iniciar sesión.');
          document.getElementById('registerForm').reset();
          // Limpiar indicadores
          updatePasswordIndicators('');
          // Redirigir al login después del registro exitoso
          window.location.href = '/login';
        } else {
          return response.json().then(data => {
            alert('Error: ' + data.error);
          });
        }
      })
      .catch(err => {
        alert('Error al registrar el usuario. Intente nuevamente.');
        console.error('Error:', err);
      })
      .finally(() => {
        // Ocultar spinner de carga
        if (window.DistriCampoUtils && window.DistriCampoUtils.showSpinner) {
          window.DistriCampoUtils.showSpinner(false);
        }
      });
    });
  </script>
</body>
</html>
