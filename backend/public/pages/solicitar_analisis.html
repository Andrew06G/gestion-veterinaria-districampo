<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitar Análisis</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body style="background-color: #b3b3b3;">
  <!-- Barra de navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
      
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item"><a class="nav-link" href="/dashboard">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/animals">Registro de Animales</a></li>
        <li class="nav-item"><a class="nav-link" href="/animal-info">Información de Animales</a></li>
        <li class="nav-item"><a class="nav-link active" href="/solicitar-analisis">Solicitar Análisis</a></li>
        <li class="nav-item"><a class="nav-link" href="/mis-analisis">Mis Análisis</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Cerrar Sesión</a></li>
      </ul>
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="text-center">Solicitar Análisis Clínico</h2>

    <!-- Primer formulario -->
    <form id="requestAnalysisForm" class="mb-4">
      <div class="form-group">
        <label for="id_animal">Seleccionar Animal:</label>
        <select class="form-control" id="id_animal" name="id_animal" required>
          <option value="">Seleccione un animal...</option>
          <!-- Opciones dinámicas -->
        </select>
      </div>
      <div class="form-group">
        <label for="tipo_analisis">Tipo de Análisis:</label>
        <select class="form-control" id="tipo_analisis" name="id_tipo_analisis" required>
          <!-- Opciones dinámicas -->
        </select>
      </div>
      <div class="form-group">
        <label for="fecha_solicitud">Fecha de Solicitud:</label>
        <input type="date" class="form-control" id="fecha_solicitud" name="fecha_solicitud" required>
      </div>
      <button type="submit" class="btn btn-primary btn-block">Solicitar Análisis</button>
    </form>
  </div>

  <!-- Incluir el sistema de gestión de sesión -->
  <script src="../assets/js/session.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Verificar autenticación usando el sistema de sesión
      if (!sessionManager.requireAuth()) {
        return;
      }
      
      // Cargar los tipos de análisis y los animales
      loadAnalysisTypes();
      loadUserAnimals();
    });

    // Cargar tipos de análisis desde el backend
    async function loadAnalysisTypes() {
      try {
        const response = await sessionManager.authenticatedFetch('/api/analyses/tipos');

        if (response && response.ok) {
          const analyses = await response.json();

          // IDs de los selectores a llenar
          const analysisSelectIds = ['tipo_analisis', 'id_tipo_analisis_alt', 'analysisType'];

          analysisSelectIds.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
              select.innerHTML = ''; // Vaciar opciones previas

              analyses.forEach(analysis => {
                const option = document.createElement('option');
                option.value = analysis.id_tipo_analisis;
                option.textContent = analysis.nombre_analisis;
                select.appendChild(option);
              });
            }
          });
        } else if (!response) {
          // La función authenticatedFetch ya maneja la redirección
          return;
        } else {
          alert('Error al cargar los tipos de análisis.');
        }
      } catch (error) {
        console.error('Error al cargar los tipos de análisis:', error);
      }
    }

    // Cargar animales del usuario desde el backend
    async function loadUserAnimals() {
      try {
        const response = await sessionManager.authenticatedFetch('/api/animals/user/list');

        if (response && response.ok) {
          const animals = await response.json();
          const animalSelect = document.getElementById('id_animal');

          if (animalSelect) {
            // Mantener la opción por defecto
            animalSelect.innerHTML = '<option value="">Seleccione un animal...</option>';

            if (animals.length === 0) {
              const option = document.createElement('option');
              option.value = '';
              option.textContent = 'No hay animales registrados';
              option.disabled = true;
              animalSelect.appendChild(option);
            } else {
              animals.forEach(animal => {
                const option = document.createElement('option');
                option.value = animal.id_animal;
                option.textContent = animal.nombre_animal;
                animalSelect.appendChild(option);
              });
            }
          }
        } else if (!response) {
          // La función authenticatedFetch ya maneja la redirección
          return;
        } else {
          alert('Error al cargar los animales.');
        }
      } catch (error) {
        console.error('Error al cargar los animales:', error);
      }
    }

    // Manejar envío de formularios para solicitar un análisis
    document.getElementById('requestAnalysisForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Obtener valores del formulario
      const id_animal = document.getElementById('id_animal').value.trim();
      const id_tipo_analisis = document.getElementById('tipo_analisis').value;
      const fecha_solicitud = document.getElementById('fecha_solicitud').value;

      // Validar campos
      if (!id_animal || !id_tipo_analisis || !fecha_solicitud) {
        alert('Por favor, complete todos los campos.');
        return;
      }

      // Enviar la solicitud al backend
      try {
        const response = await sessionManager.authenticatedFetch('/api/analyses', {
          method: 'POST',
          body: JSON.stringify({
            id_animal: id_animal,
            id_tipo_analisis: id_tipo_analisis,
            fecha_solicitud: fecha_solicitud
          })
        });

        if (response && response.ok) {
          alert('Análisis solicitado exitosamente');
          this.reset(); // Limpiar el formulario
        } else if (!response) {
          // La función authenticatedFetch ya maneja la redirección
          return;
        } else {
          const errorData = await response.json();
          alert('Error al solicitar el análisis: ' + errorData.message);
        }
      } catch (error) {
        console.error('Error al solicitar el análisis:', error);
        alert('Error al solicitar el análisis');
      }
    });

    // La función logout ya está definida en session.js
  </script>

</body>
</html>
