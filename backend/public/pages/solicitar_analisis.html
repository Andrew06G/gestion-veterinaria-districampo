<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitar Análisis</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body style="background-color: #b3b3b3;">
  <!-- Barra de navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
      <strong>DistriCampo</strong>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item"><a class="nav-link" href="/dashboard">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/animals">Registro de Animales</a></li>
        <li class="nav-item"><a class="nav-link" href="/animal-info">Información de Animales</a></li>
        <li class="nav-item"><a class="nav-link active" href="/solicitar-analisis">Solicitar Análisis</a></li>
        <li class="nav-item"><a class="nav-link" href="/mis-analisis">Mis Análisis</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Cerrar Sesión</a></li>
      </ul>
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="text-center">Solicitar Análisis Clínico</h2>

    <!-- Primer formulario -->
    <form id="requestAnalysisForm" class="mb-4">
      <div class="form-group">
        <label for="id_animal">Seleccionar Animal:</label>
        <select class="form-control" id="id_animal" name="id_animal" required>
          <option value="">Seleccione un animal...</option>
          <!-- Opciones dinámicas -->
        </select>
      </div>
      <div class="form-group">
        <label for="tipo_analisis">Tipo de Análisis:</label>
        <select class="form-control" id="tipo_analisis" name="id_tipo_analisis" required onchange="showSampleType()">
          <!-- Opciones dinámicas -->
        </select>
      </div>
      <div class="form-group">
        <label for="tipo_muestra_info">Tipo de Muestra (asignado automáticamente):</label>
        <input type="text" class="form-control" id="tipo_muestra_info" readonly style="background-color: #f8f9fa;">
      </div>
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="fecha_solicitud">Fecha de Solicitud:</label>
          <input type="date" class="form-control" id="fecha_solicitud" name="fecha_solicitud" required>
        </div>
        <div class="form-group col-md-6">
          <label for="hora_toma">Hora de toma (8:00 - 18:00):</label>
          <input type="time" class="form-control" id="hora_toma" name="hora_toma" min="08:00" max="18:00">
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-block">Solicitar Análisis</button>
    </form>
  </div>

  <!-- Incluir el sistema de gestión de sesión -->
  <script src="../assets/js/session.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Verificar autenticación usando el sistema de sesión
      if (!sessionManager.requireAuth()) {
        return;
      }
      
      // Cargar los tipos de análisis y los animales
      loadAnalysisTypes();
      loadUserAnimals();
    });

    // Cargar tipos de análisis desde el backend
    async function loadAnalysisTypes() {
      try {
        const response = await sessionManager.authenticatedFetch('/api/analyses/tipos');

        if (response && response.ok) {
          const analyses = await response.json();

          // IDs de los selectores a llenar
          const analysisSelectIds = ['tipo_analisis', 'id_tipo_analisis_alt', 'analysisType'];

          analysisSelectIds.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
              select.innerHTML = ''; // Vaciar opciones previas

              analyses.forEach(analysis => {
                const option = document.createElement('option');
                option.value = analysis.id_tipo_analisis;
                option.textContent = analysis.nombre_analisis;
                option.dataset.tipoMuestra = analysis.tipo_muestra || '';
                select.appendChild(option);
              });
            }
          });
        } else if (!response) {
          // La función authenticatedFetch ya maneja la redirección
          return;
        } else {
          alert('Error al cargar los tipos de análisis.');
        }
      } catch (error) {
        // Error al cargar los tipos de análisis
      }
    }

    // Mostrar tipo de muestra cuando se selecciona un análisis
    function showSampleType() {
      const select = document.getElementById('tipo_analisis');
      const infoField = document.getElementById('tipo_muestra_info');
      
      if (select.value) {
        const selectedOption = select.options[select.selectedIndex];
        const tipoMuestra = selectedOption.dataset.tipoMuestra;
        infoField.value = tipoMuestra || 'Se asignará automáticamente';
      } else {
        infoField.value = '';
      }
    }

    // Cargar animales del usuario desde el backend
    async function loadUserAnimals() {
      try {
        const response = await sessionManager.authenticatedFetch('/api/animals/user/list');

        if (response && response.ok) {
          const animals = await response.json();
          const animalSelect = document.getElementById('id_animal');

          if (animalSelect) {
            // Mantener la opción por defecto
            animalSelect.innerHTML = '<option value="">Seleccione un animal...</option>';

            if (animals.length === 0) {
              const option = document.createElement('option');
              option.value = '';
              option.textContent = 'No hay animales registrados';
              option.disabled = true;
              animalSelect.appendChild(option);
            } else {
              animals.forEach(animal => {
                const option = document.createElement('option');
                option.value = animal.id_animal;
                option.textContent = animal.nombre_animal;
                animalSelect.appendChild(option);
              });
            }
          }
        } else if (!response) {
          // La función authenticatedFetch ya maneja la redirección
          return;
        } else {
          alert('Error al cargar los animales.');
        }
      } catch (error) {
        // Error al cargar los animales
      }
    }

      // Establecer fecha mínima hoy
      (function setMinDateTomorrow() {
        const today = new Date();
        const tomorrow = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
        const y = tomorrow.getFullYear();
        const m = String(tomorrow.getMonth() + 1).padStart(2, '0');
        const d = String(tomorrow.getDate()).padStart(2, '0');
        document.getElementById('fecha_solicitud').setAttribute('min', `${y}-${m}-${d}`);
      })();

      // Manejar envío de formularios para solicitar un análisis
    document.getElementById('requestAnalysisForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Obtener valores del formulario
      const id_animal = document.getElementById('id_animal').value.trim();
      const id_tipo_analisis = document.getElementById('tipo_analisis').value;
      const fecha_solicitud = document.getElementById('fecha_solicitud').value;
      let hora_toma = (document.getElementById('hora_toma').value || '').trim();

      // Validar campos
      if (!id_animal || !id_tipo_analisis || !fecha_solicitud) {
        alert('Por favor, complete todos los campos.');
        return;
      }
      if (!hora_toma) {
        alert('La hora de toma es obligatoria (entre 08:00 y 18:00).');
        return;
      }

      // Validar hora si se proporcionó
      // Asegurar formato HH:MM
      if (hora_toma.length === 5) hora_toma = `${hora_toma}:00`;
      const [hh, mm] = hora_toma.split(':').map(Number);
      if (hh < 8 || (hh > 18 || (hh === 18 && mm > 0))) {
        alert('La hora de toma debe estar entre 08:00 y 18:00.');
        return;
      }

      // Validar fecha mínima mañana (evitar problemas de zona horaria)
      const today = new Date();
      const tomorrow = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
      const [sy, sm, sd] = fecha_solicitud.split('-').map(Number);
      const sel = new Date(sy, sm - 1, sd);
      if (sel < tomorrow) {
        alert('No se pueden programar citas para el mismo día. Selecciona una fecha a partir de mañana.');
        return;
      }

      // Enviar la solicitud al backend
      try {
        const response = await sessionManager.authenticatedFetch('/api/analyses', {
          method: 'POST',
          body: JSON.stringify({
            id_animal: id_animal,
            id_tipo_analisis: id_tipo_analisis,
            fecha_solicitud: fecha_solicitud,
            hora_toma: hora_toma || null
          })
        });

        if (response && response.ok) {
          alert('Análisis solicitado exitosamente');
          this.reset(); // Limpiar el formulario
        } else if (!response) {
          // La función authenticatedFetch ya maneja la redirección
          return;
        } else {
          const errorData = await response.json();
          alert('Error al solicitar el análisis: ' + errorData.message);
        }
      } catch (error) {
        alert('Error al solicitar el análisis');
      }
    });

    // La función logout ya está definida en session.js
  </script>
  
  <!-- Sistema de notificaciones -->
  <script src="../assets/js/notifications.js"></script>
</body>
</html>
